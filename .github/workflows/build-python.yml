name: PyPI

env:
  BLENDER_VERSION: "5.0"
  BLENDER_PYTHON_VERSION: "3.11"

on:
  push:
    tags:
      - 'v[0-9]+.[0-9]+.[0-9]+*'
  workflow_dispatch:
    inputs:
      tag:
        description: 'Semver tag (e.g., v1.2.3)'
        required: true
        type: string

jobs:
  build-wheels:
    name: ${{ matrix.os }} - ${{ matrix.python-version }}
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [trueform-win, trueform-linux, macos-latest]
        python-version: ["3.11", "3.12", "3.13"]

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: ${{ github.event_name == 'workflow_dispatch' && github.event.inputs.tag || github.ref }}

      # ------------------------------------------------------
      # Set Python command (python on Windows, python3 elsewhere)
      # ------------------------------------------------------
      - name: Set Python command
        shell: bash
        run: |
          if [[ "$RUNNER_OS" == "Windows" ]]; then
            echo "PY=py" >> $GITHUB_ENV
          else
            echo "PY=python3" >> $GITHUB_ENV
          fi

      # ------------------------------------------------------
      # Windows compiler environment
      # ------------------------------------------------------
      - uses: ilammy/msvc-dev-cmd@v1
        if: runner.os == 'Windows'

      - name: Set Windows compiler env
        if: runner.os == 'Windows'
        shell: bash
        run: |
          echo "CC=clang-cl.exe" >> $GITHUB_ENV
          echo "CXX=clang-cl.exe" >> $GITHUB_ENV
          echo "CMAKE_C_COMPILER=clang-cl.exe" >> $GITHUB_ENV
          echo "CMAKE_CXX_COMPILER=clang-cl.exe" >> $GITHUB_ENV
          echo "CMAKE_GENERATOR=Ninja" >> $GITHUB_ENV

      # ------------------------------------------------------
      # Linux compiler environment
      # ------------------------------------------------------
      - name: Set Linux compiler env
        if: runner.os == 'Linux'
        shell: bash
        run: |
          echo "CC=clang" >> $GITHUB_ENV
          echo "CXX=clang++" >> $GITHUB_ENV
          echo "CMAKE_C_COMPILER=clang" >> $GITHUB_ENV
          echo "CMAKE_CXX_COMPILER=clang++" >> $GITHUB_ENV

      # ------------------------------------------------------
      # Setup Python (non-Windows only)
      # Windows uses system Python; cibuildwheel downloads exact versions via nuget
      # ------------------------------------------------------
      - uses: actions/setup-python@v5
        if: runner.os != 'Windows'
        with:
          python-version: ${{ matrix.python-version }}

      # ------------------------------------------------------
      # Build and test wheels
      # Test config is in pyproject.toml [tool.cibuildwheel]
      # ------------------------------------------------------
      - name: Install cibuildwheel
        shell: bash
        run: ${{ env.PY }} -m pip install cibuildwheel==3.3.0

      - name: Build and test wheels
        shell: bash
        run: |
          VER_NO_DOT=$(echo "${{ matrix.python-version }}" | tr -d '.')
          export CIBW_BUILD="cp${VER_NO_DOT}-*"

          echo "Building for target: $CIBW_BUILD"
          $PY -m cibuildwheel --output-dir wheelhouse

      # ------------------------------------------------------
      # Package Blender plugin (Python 3.11 / Blender 5.0)
      # ------------------------------------------------------
      - name: Package Blender plugin
        if: matrix.python-version == env.BLENDER_PYTHON_VERSION
        shell: bash
        run: |
          BLENDER_PY_NO_DOT=$(echo "${{ env.BLENDER_PYTHON_VERSION }}" | tr -d '.')
          $PY python/tools/package_blender_plugin.py \
            --wheel wheelhouse/trueform-*.whl \
            --output wheelhouse/trueform-bpy-plugin-${{ runner.os }}-py${BLENDER_PY_NO_DOT}.zip

      # ------------------------------------------------------
      # Upload wheels for publish job
      # ------------------------------------------------------
      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: trueform-wheels-${{ matrix.os }}-${{ matrix.python-version }}
          path: |
            wheelhouse/*.whl
            wheelhouse/*.zip

  # ----------------------------------------------------------
  # PUBLISH WHEELS (GitHub Release + PyPI)
  # ----------------------------------------------------------
  publish:
    needs: build-wheels
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/') || github.event_name == 'workflow_dispatch'

    steps:
      - uses: actions/download-artifact@v4
        with:
          pattern: trueform-wheels-*
          merge-multiple: true
          path: dist

      - name: Upload release assets
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ github.event.inputs.tag || github.ref_name }}
          files: |
            dist/**/*.whl
            dist/**/*.zip
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
